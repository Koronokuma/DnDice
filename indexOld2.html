<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WÃ¼rfel Web App</title>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a93a6; --text:#e9edf7; --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444;
    --card:#0f1219; --border:#273043;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center}
  #configTitle{font-weight:700;font-size:18px;text-align:center}
  .toolbar{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;padding:12px 16px;flex-wrap:wrap}
  .left, .right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .option{display:flex;align-items:center;gap:8px;background:var(--panel);padding:8px 10px;border:1px solid var(--border);border-radius:10px}
  .option input[type="number"]{width:80px;background:transparent;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px}
  select, button{
    background:var(--panel);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer
  }
  button.icon{padding:8px 10px;line-height:1}
  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 16px;
    padding: 8px 16px 0 16px;
  }
  .dice-control {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .dice-control .label {
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 18px;
  }
  .dice-control .count-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .dice-control button {
    background: var(--accent);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    font-size: 22px;
    border-radius: 6px;
    cursor: pointer;
  }
  .dice-control input {
    width: 50px;
    text-align: center;
    font-size: 18px;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
  }
  .grid{
    display:grid;gap:12px;padding:12px 16px;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr))
  }
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:130px
  }
  .card .head{padding:6px 10px;font-weight:700;border-bottom:1px solid var(--border)}
  .card .num{flex:1;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px}
  .actions{display:flex;gap:10px;align-items:center;padding:8px 16px}
  .actions button.primary{background:var(--accent);border-color:transparent}
  footer{
    padding:10px 16px 18px;border-top:1px solid var(--border);
    font-weight:700
  }
  .status.ok{color:var(--ok)} .status.bad{color:var(--bad)} .status.neutral{color:var(--text)}
  .spacer{flex:1}
  @media (max-width:520px){
    .dice-control input{width:44px}
    .dice-control button{width:32px;height:32px;font-size:20px}
  }
</style>
</head>
<body>
  <header>
    <div id="configTitle"></div>
  </header>

  <div class="toolbar">
    <div class="left">
      <label class="option"><input type="checkbox" id="showAvg"> Ã˜ anzeigen</label>
      <label class="option"><input type="checkbox" id="critX2"> Crit (x2)</label>
      <label class="option">Bonus <input type="number" id="bonus" step="1" value="0"></label>
    </div>

    <div class="right">
      <select id="configSelect" title="Konfiguration laden">
        <option>- Keine -</option>
      </select>
      <button class="icon" id="saveBtn" title="Konfiguration speichern">ðŸ’¾</button>
      <button class="icon" id="deleteBtn" title="Konfiguration lÃ¶schen">ðŸ—‘</button>
    </div>
  </div>

  <div class="controls" id="diceControls"></div>

  <div class="actions">
    <button class="primary" id="rollBtn">WÃ¼rfeln</button>
    <div class="spacer"></div>
  </div>

  <section class="grid" id="cards"></section>

  <footer>
    <div id="status" class="status neutral">Ergebnis wird hier angezeigt</div>
  </footer>

<script>
(() => {
  const DICE = {
    D4:  { sides:4,  color:"#4dabf7" },
    D6:  { sides:6,  color:"#ff6b6b" },
    D8:  { sides:8,  color:"#51cf66" },
    D10: { sides:10, color:"#ffa94d" },
    D12: { sides:12, color:"#845ef7" },
    D20: { sides:20, color:"#fcc419" },
  };

  const el = (q) => document.querySelector(q);
  const configTitle = el('#configTitle');
  const cards = el('#cards');
  const status = el('#status');
  const showAvg = el('#showAvg');
  const critX2 = el('#critX2');
  const bonusInp = el('#bonus');
  const configSelect = el('#configSelect');
  const saveBtn = el('#saveBtn');
  const deleteBtn = el('#deleteBtn');
  const diceControls = el('#diceControls');
  const rollBtn = el('#rollBtn');

  const countInputs = {};
  for (const key of Object.keys(DICE)){
    const wrap = document.createElement('div');
    wrap.className = 'dice-control';

    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = key;
    label.style.color = DICE[key].color;
    wrap.appendChild(label);

    const ctrls = document.createElement('div');
    ctrls.className = 'count-controls';

    const btnMinus = document.createElement('button');
    btnMinus.textContent = 'âˆ’';
    btnMinus.addEventListener('click', () => {
      let val = parseInt(input.value || '0', 10);
      if (val > 0) input.value = val - 1;
    });

    const input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    input.step = '1';
    input.value = '0';
    input.id = `count_${key}`;

    const btnPlus = document.createElement('button');
    btnPlus.textContent = '+';
    btnPlus.addEventListener('click', () => {
      let val = parseInt(input.value || '0', 10);
      input.value = val + 1;
    });

    ctrls.appendChild(btnMinus);
    ctrls.appendChild(input);
    ctrls.appendChild(btnPlus);
    wrap.appendChild(ctrls);

    diceControls.appendChild(wrap);
    countInputs[key] = input;
  }

  const LS_KEY = 'dice_configs_v2';
  const readConfigs = () => {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }
    catch { return {}; }
  };
  const writeConfigs = (obj) => localStorage.setItem(LS_KEY, JSON.stringify(obj));

  const updateConfigDropdown = () => {
    const cfgs = readConfigs();
    const current = configSelect.value;
    configSelect.innerHTML = '<option>- Keine -</option>' +
      Object.keys(cfgs).map(n => `<option>${n}</option>`).join('');
    if ([...configSelect.options].some(o => o.value === current)){
      configSelect.value = current;
    }
  };

  const loadConfig = (name) => {
    if (!name || name === '- Keine -'){
      configTitle.textContent = '';
      return;
    }
    const cfgs = readConfigs();
    const data = cfgs[name];
    if (!data) return;

    const counts = data.counts || data;
    const meta = data.meta || {};

    for (const k of Object.keys(DICE)){
      countInputs[k].value = counts[k] ?? '0';
    }
    bonusInp.value = (meta.bonus ?? 0);
    critX2.checked = !!meta.crit;
    showAvg.checked = !!meta.show_avg;

    configTitle.textContent = name;
  };

  const saveConfig = () => {
    const name = prompt('Name der Konfiguration:');
    if (!name) return;

    const counts = {};
    for (const k of Object.keys(DICE)){
      counts[k] = String(parseInt(countInputs[k].value || '0', 10) || 0);
    }
    const meta = {
      bonus: parseInt(bonusInp.value || '0', 10) || 0,
      crit: !!critX2.checked,
      show_avg: !!showAvg.checked,
    };

    const cfgs = readConfigs();
    cfgs[name] = { counts, meta };
    writeConfigs(cfgs);

    updateConfigDropdown();
    configSelect.value = name;
    loadConfig(name);
    alert(`Konfiguration â€ž${name}â€œ gespeichert.`);
  };

  const deleteConfig = () => {
    const name = configSelect.value;
    if (!name || name === '- Keine -'){
      alert('Keine Konfiguration ausgewÃ¤hlt.');
      return;
    }
    if (!confirm(`â€ž${name}â€œ wirklich lÃ¶schen?`)) return;
    const cfgs = readConfigs();
    delete cfgs[name];
    writeConfigs(cfgs);
    updateConfigDropdown();
    configSelect.value = '- Keine -';
    loadConfig('- Keine -');
    alert('GelÃ¶scht.');
  };

  const roll = () => {
    cards.innerHTML = '';
    status.className = 'status neutral';
    const results = [];
    let totalAvg = 0;

    for (const [key, spec] of Object.entries(DICE)){
      const n = Math.max(0, parseInt(countInputs[key].value || '0', 10) || 0);
      if (!n) continue;

      const avgPerDie = (1 + spec.sides) / 2;
      totalAvg += avgPerDie * n;

      for (let i=0;i<n;i++){
        const value = 1 + Math.floor(Math.random()*spec.sides);
        results.push({key, value, color: spec.color});
        const card = document.createElement('div');
        card.className = 'card';
        const head = document.createElement('div');
        head.className = 'head';
        head.style.background = 'transparent';
        head.style.color = spec.color;
        head.textContent = key;
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = value;
        card.appendChild(head);
        card.appendChild(num);
        cards.appendChild(card);
      }
    }

    if (results.length === 0){
      status.textContent = 'Keine WÃ¼rfel ausgewÃ¤hlt.';
      return;
    }

    const bonus = parseInt(bonusInp.value || '0', 10) || 0;
    let total = results.reduce((a,b)=>a+b.value, 0) + bonus;
    if (critX2.checked) total *= 2;

    if (showAvg.checked){
      totalAvg += bonus;
      if (critX2.checked) totalAvg *= 2;
      const diff = total - totalAvg;
      let cls = 'neutral';
      if (diff > 0.0001) cls = 'ok';
      else if (diff < -0.0001) cls = 'bad';
      status.className = `status ${cls}`;
      const sign = diff>0?'+':'';
      status.textContent = `Gesamt: ${total} (Ã˜: ${totalAvg.toFixed(1)}, Abweichung: ${sign}${diff.toFixed(1)})`;
    } else {
      status.className = 'status neutral';
      status.textContent = `Gesamt: ${total}`;
    }
  };

  rollBtn.addEventListener('click', roll);
  saveBtn.addEventListener('click', saveConfig);
  deleteBtn.addEventListener('click', deleteConfig);
  configSelect.addEventListener('change', (e)=> loadConfig(e.target.value));

  updateConfigDropdown();
  loadConfig(configSelect.value);
})();
</script>
</body>
</html>
